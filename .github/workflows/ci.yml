name: CI

on:
  push:
    branches: [main]
  pull_request:

env:
  PYTHON_VERSION: "3.14"

jobs:
  ruff:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true
          python-version: ${{ env.PYTHON_VERSION }}
      - uses: actions/cache@v4
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-${{ hashFiles('uv.lock') }}
          restore-keys: venv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-
      - run: uv sync --dev
      - uses: actions/cache@v4
        with:
          path: .ruff_cache
          key: ruff-${{ hashFiles('pyproject.toml') }}
          restore-keys: ruff-
      - run: uv run ruff check src tests
      - run: uv run ruff format --check src tests

  mypy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true
          python-version: ${{ env.PYTHON_VERSION }}
      - uses: actions/cache@v4
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-${{ hashFiles('uv.lock') }}
          restore-keys: venv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-
      - run: uv sync --dev
      - uses: actions/cache@v4
        with:
          path: .mypy_cache
          key: mypy-${{ hashFiles('pyproject.toml') }}
          restore-keys: mypy-
      - run: uv run mypy src

  ty:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true
          python-version: ${{ env.PYTHON_VERSION }}
      - uses: actions/cache@v4
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-${{ hashFiles('uv.lock') }}
          restore-keys: venv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-
      - run: uv sync --dev
      - run: uv run ty check src

  # pyrefly: Django/DRF のサードパーティ型に未対応のため一時無効化
  # pyrefly:
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: astral-sh/setup-uv@v4
  #       with:
  #         enable-cache: true
  #         python-version: ${{ env.PYTHON_VERSION }}
  #     - uses: actions/cache@v4
  #       with:
  #         path: .venv
  #         key: venv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-${{ hashFiles('uv.lock') }}
  #         restore-keys: venv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-
  #     - run: uv sync --dev
  #     - run: uv run pyrefly check

  unit_test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true
          python-version: ${{ env.PYTHON_VERSION }}
      - uses: actions/cache@v4
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-${{ hashFiles('uv.lock') }}
          restore-keys: venv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-
      - run: uv sync --dev
      - run: uv run pytest tests/unit --numprocesses auto

  functional_test:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_DB: django_db
          POSTGRES_USER: django
          POSTGRES_PASSWORD: django
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U django"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    env:
      POSTGRES_HOST: localhost
      POSTGRES_DB: django_db
      POSTGRES_USER: django
      POSTGRES_PASSWORD: django
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true
          python-version: ${{ env.PYTHON_VERSION }}
      - uses: actions/cache@v4
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-${{ hashFiles('uv.lock') }}
          restore-keys: venv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-
      - run: uv sync --dev
      - run: uv run pytest tests/functional --numprocesses auto

  integration_test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true
          python-version: ${{ env.PYTHON_VERSION }}
      - uses: actions/cache@v4
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-${{ hashFiles('uv.lock') }}
          restore-keys: venv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-
      - run: uv sync --dev
      - run: uv run pytest tests/integration --maxfail=1 --disable-warnings -q

  # e2e_test:
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: astral-sh/setup-uv@v4
  #       with:
  #         enable-cache: true
  #         python-version: ${{ env.PYTHON_VERSION }}
  #     - uses: actions/cache@v4
  #       with:
  #         path: .venv
  #         key: venv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-${{ hashFiles('uv.lock') }}
  #         restore-keys: venv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-
  #     - run: uv sync --dev
  #     - run: uv run pytest tests/e2e --maxfail=1 --disable-warnings -q

  commitlint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: npm
      - run: npm ci
      - run: |
          LAST_COMMIT=$(git log -1 --pretty=%B)
          echo "$LAST_COMMIT" | npx commitlint
