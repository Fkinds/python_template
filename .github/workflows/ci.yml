name: CI

on:
  push:
    branches: [main]
  pull_request:

env:
  PYTHON_VERSION: "3.14"

jobs:
  label:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            const title = context.payload.pull_request.title;
            const map = {
              feature: /^feat/,
              fix: /^fix/,
              refactor: /^refactor/,
              chore: /^chore/,
              docs: /^docs/,
              ci: /^ci/,
              test: /^test/,
            };
            const labels = Object.entries(map)
              .filter(([, re]) => re.test(title))
              .map(([k]) => k);
            if (labels.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels,
              });
            }

  block-fixup:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Block fixup! and squash! commits
        run: |
          COMMITS=$(git log --format='%s' origin/${{ github.base_ref }}..HEAD)
          if echo "$COMMITS" | grep -qE '^(fixup!|squash!) '; then
            echo "::error::Found fixup! or squash! commits. Please rebase before merging."
            echo "$COMMITS" | grep -E '^(fixup!|squash!) '
            exit 1
          fi

  ruff:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true
          python-version: ${{ env.PYTHON_VERSION }}
      - uses: actions/cache@v4
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-${{ hashFiles('uv.lock') }}
          restore-keys: venv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-
      - run: uv sync --dev
      - uses: actions/cache@v4
        with:
          path: .ruff_cache
          key: ruff-${{ hashFiles('pyproject.toml') }}
          restore-keys: ruff-
      - run: uv run ruff check src tests
      - run: uv run ruff format --check src tests

  mypy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true
          python-version: ${{ env.PYTHON_VERSION }}
      - uses: actions/cache@v4
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-${{ hashFiles('uv.lock') }}
          restore-keys: venv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-
      - run: uv sync --dev
      - uses: actions/cache@v4
        with:
          path: .mypy_cache
          key: mypy-${{ hashFiles('pyproject.toml') }}
          restore-keys: mypy-
      - run: uv run mypy src

  ty:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true
          python-version: ${{ env.PYTHON_VERSION }}
      - uses: actions/cache@v4
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-${{ hashFiles('uv.lock') }}
          restore-keys: venv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-
      - run: uv sync --dev
      - run: uv run ty check src

  unit_test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true
          python-version: ${{ env.PYTHON_VERSION }}
      - uses: actions/cache@v4
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-${{ hashFiles('uv.lock') }}
          restore-keys: venv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-
      - run: uv sync --dev
      - run: uv run pytest tests/unit --numprocesses auto

  functional_test:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_DB: django_db
          POSTGRES_USER: django
          POSTGRES_PASSWORD: django
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U django"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    env:
      POSTGRES_HOST: localhost
      POSTGRES_DB: django_db
      POSTGRES_USER: django
      POSTGRES_PASSWORD: django
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true
          python-version: ${{ env.PYTHON_VERSION }}
      - uses: actions/cache@v4
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-${{ hashFiles('uv.lock') }}
          restore-keys: venv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-
      - run: uv sync --dev
      - run: uv run pytest tests/functional --numprocesses auto

  integration_test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true
          python-version: ${{ env.PYTHON_VERSION }}
      - uses: actions/cache@v4
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-${{ hashFiles('uv.lock') }}
          restore-keys: venv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-
      - run: uv sync --dev
      - run: uv run pytest tests/integration --maxfail=1 --disable-warnings -q

  commitlint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: npm
      - run: npm ci
      - run: |
          LAST_COMMIT=$(git log -1 --pretty=%B)
          echo "$LAST_COMMIT" | npx commitlint
